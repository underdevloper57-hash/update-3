<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AlphaFlow â€“ Live Terminal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
  
  <style>
    /* --- 1. THEME VARIABLES --- */
    :root {
      --bg: #020617;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --glass: rgba(15, 23, 42, 0.95);
      --glass-light: rgba(30, 41, 59, 0.4);
      --border: rgba(148, 163, 184, 0.15);
      --bullish: #00E396;
      --bearish: #FF4560;
    }

    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
    * { box-sizing: border-box; }

    /* --- 2. BACKGROUND ANIMATION --- */
    #bgCanvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; opacity: 0.6; pointer-events: none;
    }

    /* --- 3. NAVIGATION BAR --- */
    .nav-bar {
        position: sticky; top: 0; padding: 1rem 1.5rem;
        background: rgba(2,6,23,0.9); backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
        z-index: 100;
    }
    .brand { font-weight: 800; font-size: 1.1rem; color: #fff; text-decoration: none; display: flex; gap: 10px; align-items: center; }
    .logo { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 15px var(--accent); }
    .nav-link { color: var(--muted); text-decoration: none; font-size: 0.85rem; transition: 0.3s; cursor: pointer; }
    .nav-link:hover { color: var(--accent); }

    /* --- 4. MAIN LAYOUT --- */
    .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; min-height: 90vh; display: flex; flex-direction: column; position: relative; z-index: 5; }
    
    /* --- 5. SEARCH SECTION --- */
    .search-section { text-align: center; margin-bottom: 2rem; position: relative; z-index: 50; }
    .search-wrapper { position: relative; width: 100%; max-width: 500px; margin: 0 auto; }

    .search-box {
        display: flex; gap: 8px; width: 100%;
        background: rgba(30, 41, 59, 0.6); padding: 8px;
        border-radius: 12px; border: 1px solid var(--border);
        backdrop-filter: blur(10px); transition: 0.3s;
    }
    .search-box:focus-within { border-color: var(--accent); box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }

    input {
        flex: 1; background: transparent; border: none; padding: 8px;
        color: #fff; font-size: 1rem; outline: none; min-width: 0;
    }
    .analyze-btn {
        background: var(--accent); color: #000; border: none;
        padding: 10px 15px; border-radius: 8px; font-weight: bold;
        cursor: pointer; flex-shrink: 0; font-size: 0.8rem; transition: 0.3s;
    }
    .analyze-btn:hover { filter: brightness(1.1); transform: scale(1.02); }
    
    /* QUICK CHIPS */
    .quick-chips { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .chip {
        background: rgba(255,255,255,0.05); border: 1px solid var(--border);
        padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; color: var(--muted);
        cursor: pointer; transition: 0.2s;
    }
    .chip:hover { background: rgba(56, 189, 248, 0.1); color: var(--accent); border-color: var(--accent); }

    /* DROPDOWN LIST */
    .suggestions-list {
        position: absolute; top: 105%; left: 0; width: 100%;
        background: rgba(11, 17, 32, 0.98); border: 1px solid var(--border);
        border-radius: 12px; padding: 0; margin: 0; list-style: none;
        max-height: 300px; overflow-y: auto; display: none; z-index: 1000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.9); backdrop-filter: blur(12px);
        scrollbar-width: thin; scrollbar-color: var(--accent) transparent;
    }
    .suggestions-list.active { display: block; animation: slideDown 0.2s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .suggestions-list li {
        padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05);
        cursor: pointer; color: var(--muted); text-align: left; font-size: 0.9rem;
        display: flex; justify-content: space-between; transition: 0.2s;
    }
    .suggestions-list li:hover { background: rgba(56, 189, 248, 0.15); color: #fff; padding-left: 10px; }
    .stock-ticker { font-weight: bold; color: var(--accent); font-family: 'JetBrains Mono'; }
    .stock-name { font-size: 0.8rem; opacity: 0.7; }

    /* --- INITIAL STATE UI --- */
    .initial-state { text-align: center; margin-top: 2rem; animation: fadeIn 0.5s ease-out; }
    .market-pulse-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px; margin-bottom: 3rem;
    }
    .pulse-card {
        background: var(--glass-light); border: 1px solid var(--border);
        padding: 20px; border-radius: 16px; text-align: left; position: relative;
        overflow: hidden; transition: transform 0.3s;
    }
    .pulse-card:hover { transform: translateY(-5px); border-color: var(--accent); }
    .pulse-header { font-size: 0.8rem; color: var(--muted); margin-bottom: 5px; display: flex; justify-content: space-between; }
    .pulse-price { font-size: 1.5rem; font-weight: 700; color: #fff; font-family: 'JetBrains Mono'; }
    .pulse-change { font-size: 0.9rem; font-weight: 600; }
    .pulse-dot { width: 8px; height: 8px; background: var(--bullish); border-radius: 50%; animation: pulse 2s infinite; }
    .pulse-card.down .pulse-dot { background: var(--bearish); }
    .pulse-card.down .pulse-change { color: var(--bearish); }
    .pulse-card.up .pulse-change { color: var(--bullish); }

    .features-title { font-size: 1.2rem; margin-bottom: 20px; color: #fff; font-weight: 600; }
    .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    
    /* UPDATED FEATURE CARDS WITH ANIMATION */
    .feature-item {
        background: rgba(255,255,255,0.02);
        border: 1px solid var(--border);
        padding: 25px;
        border-radius: 16px;
        text-align: left;
        position: relative;
        overflow: hidden;
        /* Smooth, springy transition for hover */
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        /* Entrance animation */
        animation: fadeUp 0.6s ease-out backwards;
        /* New for neon border effect */
        z-index: 1;
    }

    /* Staggered entrance delays */
    .feature-item:nth-child(1) { animation-delay: 0.1s; }
    .feature-item:nth-child(2) { animation-delay: 0.2s; }
    .feature-item:nth-child(3) { animation-delay: 0.3s; }
    .feature-item:nth-child(4) { animation-delay: 0.4s; }

    /* Hover Effects */
    .feature-item:hover {
        transform: translateY(-10px) scale(1.02);
        background: rgba(56, 189, 248, 0.05); /* Subtle accent BG */
        border-color: transparent; /* Hide original border */
        box-shadow: 0 20px 40px -10px rgba(56, 189, 248, 0.2);
    }
    
    /* Subtle glow element on hover */
    .feature-item::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.1), transparent 70%);
        opacity: 0; transition: opacity 0.4s; pointer-events: none; z-index: -2;
    }
    .feature-item:hover::before { opacity: 1; }

    /* Neon running border effect */
    .feature-item::after {
        content: '';
        position: absolute;
        top: -2px; left: -2px; right: -2px; bottom: -2px;
        background: linear-gradient(90deg, var(--accent), transparent, var(--accent), transparent);
        background-size: 400% 100%;
        border-radius: 18px; /* Slightly larger than card radius */
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }

    .feature-item:hover::after {
        opacity: 1;
        animation: neonBorderRun 3s linear infinite;
    }

    @keyframes neonBorderRun {
        0% { background-position: 0% 50%; }
        100% { background-position: 400% 50%; }
    }

    /* Removed .feat-icon styles */
    .feat-head { font-weight: 700; color: #fff; margin-bottom: 8px; font-size: 1.1rem; }
    .feat-desc { font-size: 0.85rem; color: var(--muted); line-height: 1.6; }

    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    @keyframes pulse { 0% { opacity: 1; box-shadow: 0 0 0 0 rgba(0, 227, 150, 0.7); } 70% { opacity: 0.7; box-shadow: 0 0 0 10px rgba(0, 227, 150, 0); } 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0, 227, 150, 0); } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }


    /* --- LOADING SPINNER --- */
    .loader { display: none; text-align: center; margin: 2rem 0; }
    .spinner {
        width: 40px; height: 40px; border: 4px solid rgba(56, 189, 248, 0.1);
        border-top: 4px solid var(--accent); border-radius: 50%;
        animation: spin 1s linear infinite; margin: 0 auto 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- DASHBOARD GRID --- */
    .dashboard-grid {
        display: none; grid-template-columns: 2fr 1fr; gap: 20px;
        animation: fadeUp 0.5s ease-out;
    }
    @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

    /* CARDS & STATS */
    .card {
        background: rgba(11, 17, 32, 0.8); border: 1px solid var(--border);
        border-radius: 16px; padding: 20px; backdrop-filter: blur(5px);
    }
    
    .price-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
    @media(min-width: 600px) { .price-header { flex-direction: row; justify-content: space-between; align-items: flex-start; } }
    
    .ticker-name { font-size: 1.8rem; font-weight: bold; color: #fff; margin-bottom: 5px; line-height: 1; }
    .full-name { font-size: 0.9rem; color: var(--muted); font-weight: normal; display: block; }
    .current-price { font-size: 1.4rem; color: #fff; font-weight: bold; }
    
    .prediction-container { display: flex; gap: 10px; width: 100%; }
    .pred-box { flex: 1; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--border); text-align: center; }
    .pred-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
    .pred-val { font-size: 1.2rem; font-weight: bold; color: #fff; }
    .open-val { color: var(--accent); }
    .close-val { color: var(--bullish); }

    /* FUNDAMENTALS GRID */
    .fund-title {
        font-size: 0.9rem; font-weight: 600; color: #fff; margin: 20px 0 10px 0;
        border-top: 1px solid var(--border); padding-top: 15px;
    }
    .fund-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    @media(min-width: 600px) { .fund-grid { grid-template-columns: repeat(4, 1fr); } }
    
    .fund-item { background: rgba(255,255,255,0.02); padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
    .fund-label { font-size: 0.7rem; color: var(--muted); display: block; margin-bottom: 4px; }
    .fund-val { font-size: 0.9rem; color: #e2e8f0; font-weight: 600; }

    /* ACCURACY TABLE */
    .accuracy-table { width: 100%; font-size: 0.8rem; text-align: left; margin-top: 10px; border-collapse: collapse; }
    .accuracy-table th { color: var(--muted); padding-bottom: 5px; border-bottom: 1px solid var(--border); }
    .accuracy-table td { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: #fff; }

    .stat-row { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
    .stat-val { color: #fff; font-weight: 600; }

    /* NEWS IMPACT CARD */
    .news-impact-card {
        background: rgba(56, 189, 248, 0.05); border-radius: 8px; padding: 15px;
        border-left: 3px solid var(--accent); margin-bottom: 15px;
    }
    .news-head { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 5px; display: flex; justify-content: space-between; }
    .news-text { font-size: 0.9rem; color: #fff; line-height: 1.5; font-style: italic; }

    /* NEURAL LOGIC BOXES */
    .model-explain {
        background: rgba(56, 189, 248, 0.05); border-radius: 8px; padding: 15px;
        border-left: 3px solid var(--accent); font-size: 0.85rem; color: var(--text);
        line-height: 1.6; margin-bottom: 15px;
    }
    .model-title { font-weight: bold; color: #fff; display: block; margin-bottom: 4px; }
    .ensemble-math {
        font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--muted);
        padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-top: 5px; text-align: center;
    }

    /* --- CHATBOT WIDGET --- */
    .chat-btn {
        position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px;
        background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 20px rgba(56, 189, 248, 0.4); z-index: 999; cursor: pointer; transition: 0.3s;
    }
    .chat-btn:hover { transform: scale(1.1); }
    .chat-window {
        position: fixed; bottom: 80px; right: 20px; width: 300px; height: 400px;
        background: rgba(11, 17, 32, 0.95); border: 1px solid var(--border);
        border-radius: 20px; display: none; flex-direction: column; overflow: hidden; z-index: 999;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .chat-header { background: rgba(56, 189, 248, 0.1); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .chat-body { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .chat-input-area { padding: 10px; display: flex; gap: 5px; background: rgba(0,0,0,0.2); }
    .chat-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 20px; padding: 10px 15px; color: #fff; outline: none; }
    .chat-send { background: var(--accent); border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .msg { padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; font-size: 0.85rem; max-width: 85%; }
    .msg.bot { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 2px; }
    .msg.user { background: var(--accent); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; font-weight: 500; }
    .typing { font-size: 0.7rem; color: var(--muted); margin-left: 10px; display: none; margin-bottom: 5px; }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="nav-bar">
      <a href="/" class="brand"><div class="logo"></div> AlphaFlow</a>
      <a href="/" class="nav-link">Back</a>
  </div>

  <div class="chat-btn" onclick="document.getElementById('chatWindow').style.display = document.getElementById('chatWindow').style.display === 'flex' ? 'none' : 'flex'">ðŸ’¬</div>
  <div class="chat-window" id="chatWindow">
      <div style="padding:15px; border-bottom:1px solid #333; font-weight:bold; color:#fff; display:flex; justify-content:space-between;">
          <span>AlphaBot</span><span onclick="document.getElementById('chatWindow').style.display='none'" style="cursor:pointer;">âœ•</span>
      </div>
      <div class="chat-body" id="chatBody"><div class="msg bot">Hi! Ask me about stocks.</div></div>
      <div class="chat-input-area"><input id="chatInput" style="background:#222; border:none; color:#fff; flex:1; padding:8px; border-radius:4px; outline:none;" placeholder="Type..." onkeypress="if(event.key==='Enter') sendChat()"><button onclick="sendChat()" style="background:var(--accent); border:none; padding:0 10px; border-radius:4px; font-weight:bold; cursor:pointer;">âž¤</button></div>
  </div>

  <div class="container">
      
      <!-- SEARCH -->
      <div class="search-section">
          <h1 style="font-size:1.8rem; margin-bottom:10px;">Stock Predictor</h1>
          <p style="color:var(--muted); margin-bottom:15px;">Select a stock to initialize Neural Network analysis.</p>
          
          <div class="search-wrapper">
              <div class="search-box">
                  <input type="text" id="tickerInput" placeholder="Search Ticker..." autocomplete="off">
                  <button class="analyze-btn" onclick="runAnalysis()">SEARCH</button>
              </div>
              <ul class="suggestions-list" id="stockList"></ul>
          </div>

          <!-- QUICK CHIPS -->
          <div class="quick-chips">
              <span class="chip" onclick="quickSearch('RELIANCE')">Reliance</span>
              <span class="chip" onclick="quickSearch('TCS')">TCS</span>
              <span class="chip" onclick="quickSearch('HDFCBANK')">HDFC Bank</span>
              <span class="chip" onclick="quickSearch('INFY')">Infosys</span>
              <span class="chip" onclick="quickSearch('NIFTY')">Nifty 50</span>
          </div>
      </div>

      <!-- INITIAL STATE (MARKET OVERVIEW) -->
      <div id="initial-state" class="initial-state">
          <h2 class="fund-title" style="border:none; margin-bottom:20px; text-align:center;">Market Pulse</h2>
          <div class="market-pulse-grid">
              <div class="pulse-card up">
                  <div class="pulse-header"><span>NIFTY 50</span><div class="pulse-dot"></div></div>
                  <div class="pulse-price">24,130.50</div>
                  <div class="pulse-change">â–² 0.45%</div>
              </div>
              <div class="pulse-card down">
                  <div class="pulse-header"><span>SENSEX</span><div class="pulse-dot"></div></div>
                  <div class="pulse-price">79,540.20</div>
                  <div class="pulse-change">â–¼ 0.12%</div>
              </div>
              <div class="pulse-card up">
                  <div class="pulse-header"><span>BTC/USD</span><div class="pulse-dot"></div></div>
                  <div class="pulse-price">$94,200</div>
                  <div class="pulse-change">â–² 3.8%</div>
              </div>
          </div>

          <div class="features-title">System Architecture</div>
          <div class="features-grid">
              <!-- Updated Feature Cards: Icons Removed, Animations Added -->
              <div class="feature-item">
                  <div class="feat-head">LSTM Model</div>
                  <div class="feat-desc">Analyzes sequential price patterns over 60 days.</div>
              </div>
              <div class="feature-item">
                  <div class="feat-head">XGBoost</div>
                  <div class="feat-desc">Filters trades based on volatility and technical indicators.</div>
              </div>
              <div class="feature-item">
                  <div class="feat-head">Random Forest</div>
                  <div class="feat-desc">Reduces variance and prevents overfitting.</div>
              </div>
              <div class="feature-item">
                  <div class="feat-head">Ensemble Logic</div>
                  <div class="feat-desc">Weighted average of all models for max accuracy.</div>
              </div>
          </div>
      </div>

      <!-- LOADER -->
      <div id="loader" style="display:none; text-align:center; color:var(--accent);">
          <div class="spinner"></div>
          Running LSTM & XGBoost Models...
      </div>

      <!-- RESULTS AREA -->
      <div class="dashboard-grid" id="results">
          
          <!-- LEFT: CHART & FUNDAMENTALS -->
          <div class="card">
              <div class="price-header">
                  <div>
                      <div class="ticker-name"><span id="d-ticker">--</span> <span class="full-name" id="d-name"></span></div>
                      <div class="current-price" id="d-current">--</div>
                  </div>
                  <div class="prediction-container">
                      <div class="pred-box">
                          <div class="pred-label">Target Open</div>
                          <div class="pred-val open-val" id="d-open">--</div>
                      </div>
                      <div class="pred-box" style="border-color:rgba(0,227,150,0.3)">
                          <div class="pred-label">Target Close</div>
                          <div class="pred-val close-val" id="d-close">--</div>
                      </div>
                  </div>
              </div>
              <div id="mainChart" style="min-height: 300px;"></div>

              <!-- FUNDAMENTALS GRID -->
              <div class="fund-title">Market Stats</div>
              <div class="fund-grid">
                  <div class="fund-item"><span class="fund-label">Market Cap</span><span class="fund-val" id="f-cap">--</span></div>
                  <div class="fund-item"><span class="fund-label">P/E Ratio</span><span class="fund-val" id="f-pe">--</span></div>
                  <div class="fund-item"><span class="fund-label">ROE</span><span class="fund-val" id="f-roe">--</span></div>
                  <div class="fund-item"><span class="fund-label">Div Yield</span><span class="fund-val" id="f-div">--</span></div>
                  <div class="fund-item"><span class="fund-label">52W High</span><span class="fund-val" id="f-52h">--</span></div>
                  <div class="fund-item"><span class="fund-label">52W Low</span><span class="fund-val" id="f-52l">--</span></div>
                  <div class="fund-item"><span class="fund-label">P/B Ratio</span><span class="fund-val" id="f-pb">--</span></div>
                  <div class="fund-item"><span class="fund-label">Book Value</span><span class="fund-val" id="f-book">--</span></div>
              </div>
          </div>

          <!-- RIGHT: AI INSIGHTS -->
          <div style="display:flex; flex-direction:column; gap:15px;">
              
              <!-- Accuracy Card -->
              <div class="card">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                      <span style="color:var(--muted); font-size:0.85rem;">WEEKLY ACCURACY</span>
                      <span style="color:var(--bullish); font-weight:bold;" id="d-acc-week">--%</span>
                  </div>
                  <div style="width:100%; height:4px; background:rgba(255,255,255,0.1); border-radius:2px; margin-bottom:15px;">
                      <div id="acc-bar" style="width:0%; height:100%; background:var(--bullish); border-radius:2px;"></div>
                  </div>
                  <table class="accuracy-table">
                      <thead><tr><th>Date</th><th>Pred</th><th>Actual</th><th>Acc %</th></tr></thead>
                      <tbody id="acc-table-body"></tbody>
                  </table>
              </div>

              <!-- News Impact -->
              <div class="card" style="padding:0; border:none; background:transparent;">
                 <div class="news-impact-card">
                      <div class="news-head">
                          <span>NEWS IMPACT</span>
                          <span id="news-score" style="font-weight:bold;">--</span>
                      </div>
                      <div class="news-text" id="news-summary">Analysis pending...</div>
                      <div style="font-size:0.75rem; color:var(--muted); margin-top:8px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;" id="news-headline">Latest: --</div>
                  </div>
              </div>
              
              <!-- Neural Logic -->
              <div class="card" style="flex:1;">
                  <div style="margin-bottom:15px; font-weight:bold; color:#fff; font-size:1rem;">Neural Logic</div>
                  
                  <div class="model-explain">
                      <span style="color:var(--accent); font-weight:bold;">1. LSTM Model</span> Target: <span id="d-lstm">--</span><br>
                      <span style="color:var(--muted)">Detected <span id="lstm-trend">--</span> momentum.</span>
                  </div>

                  <div class="model-explain" style="border-left-color:#facc15;">
                      <span style="color:#facc15; font-weight:bold;">2. XGBoost</span> Target: <span id="d-xgb">--</span><br>
                      <span style="color:var(--muted)">Filtered by volatility.</span>
                  </div>

                  <div class="model-explain" style="border-left-color:#e11d48;">
                      <span style="color:#e11d48; font-weight:bold;">3. Decision Tree</span> Target: <span id="d-dt">--</span><br>
                      <span style="color:var(--muted)">Rule-based classification.</span>
                  </div>

                  <div class="model-explain" style="border-left-color:#22c55e;">
                      <span style="color:#22c55e; font-weight:bold;">4. Random Forest</span> Target: <span id="d-rf">--</span><br>
                      <span style="color:var(--muted)">Stability check passed.</span>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
    // BG Animation
    (function(){ const canvas=document.getElementById('bgCanvas');const ctx=canvas.getContext('2d'); let w,h,ticks=0; function resize(){w=window.innerWidth;h=window.innerHeight;ctx.canvas.width=w;ctx.canvas.height=h;} window.addEventListener('resize',resize); resize(); function draw(){ ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(56,189,248,0.15)'; for(let x=0;x<w;x+=30) for(let y=0;y<h;y+=30) { const s=Math.sin((x*0.01)+(y*0.01)+(ticks*0.02))*1.5+1.5; if(s>0){ctx.beginPath();ctx.arc(x,y,s,0,Math.PI*2);ctx.fill();} } ticks++; requestAnimationFrame(draw); } draw(); })();

    // Chat
    function toggleChat() { document.getElementById('chatWindow').style.display = document.getElementById('chatWindow').style.display === 'flex' ? 'none' : 'flex'; }
    async function sendChat() {
        const input = document.getElementById('chatInput'); const msg = input.value; if(!msg) return;
        const body = document.getElementById('chatBody');
        body.innerHTML += `<div class="msg user">${msg}</div>`; input.value=""; body.scrollTop=body.scrollHeight;
        try {
            const res = await fetch('/api/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:msg})});
            const data = await res.json();
            body.innerHTML += `<div class="msg bot">${data.response}</div>`; body.scrollTop=body.scrollHeight;
        } catch(e){ body.innerHTML += `<div class="msg bot">Error</div>`; }
    }

    // --- DROPDOWN LOGIC ---
    const stocks = [
        {sym:'RELIANCE', name:'Reliance Industries'}, {sym:'TCS', name:'Tata Consultancy'}, {sym:'HDFCBANK', name:'HDFC Bank'}, {sym:'INFY', name:'Infosys'},
        {sym:'ICICIBANK', name:'ICICI Bank'}, {sym:'SBIN', name:'State Bank of India'}, {sym:'ITC', name:'ITC Ltd'}, {sym:'BHARTIARTL', name:'Bharti Airtel'},
        {sym:'KOTAKBANK', name:'Kotak Bank'}, {sym:'LT', name:'Larsen & Toubro'}, {sym:'HINDUNILVR', name:'HUL'}, {sym:'AXISBANK', name:'Axis Bank'},
        {sym:'ASIANPAINT', name:'Asian Paints'}, {sym:'MARUTI', name:'Maruti Suzuki'}, {sym:'SUNPHARMA', name:'Sun Pharma'}, {sym:'TITAN', name:'Titan Company'},
        {sym:'BAJFINANCE', name:'Bajaj Finance'}, {sym:'HCLTECH', name:'HCL Tech'}, {sym:'TATAMOTORS', name:'Tata Motors'}, {sym:'ADANIENT', name:'Adani Enterprises'},
        {sym:'TATASTEEL', name:'Tata Steel'}, {sym:'NTPC', name:'NTPC Ltd'}, {sym:'POWERGRID', name:'Power Grid Corp'}, {sym:'M&M', name:'Mahindra & Mahindra'},
        {sym:'ULTRACEMCO', name:'UltraTech Cement'}, {sym:'NESTLEIND', name:'Nestle India'}, {sym:'WIPRO', name:'Wipro'}, {sym:'ONGC', name:'ONGC'},
        {sym:'COALINDIA', name:'Coal India'}, {sym:'BAJAJFINSV', name:'Bajaj Finserv'}, {sym:'JSWSTEEL', name:'JSW Steel'}, {sym:'ADANIPORTS', name:'Adani Ports'},
        {sym:'TECHM', name:'Tech Mahindra'}, {sym:'HINDALCO', name:'Hindalco'}, {sym:'GRASIM', name:'Grasim'}, {sym:'DRREDDY', name:'Dr Reddy'},
        {sym:'CIPLA', name:'Cipla'}, {sym:'INDUSINDBK', name:'IndusInd Bank'}, {sym:'SBILIFE', name:'SBI Life'}, {sym:'HDFCLIFE', name:'HDFC Life'},
        {sym:'DIVISLAB', name:'Divis Labs'}, {sym:'APOLLOHOSP', name:'Apollo Hospitals'}, {sym:'EICHERMOT', name:'Eicher Motors'}, {sym:'BPCL', name:'BPCL'},
        {sym:'BAJAJ-AUTO', name:'Bajaj Auto'}, {sym:'TATACONSUM', name:'Tata Consumer'}, {sym:'BRITANNIA', name:'Britannia'}, {sym:'HEROMOTOCO', name:'Hero MotoCorp'},
        {sym:'UPL', name:'UPL'}, {sym:'LTIM', name:'LTIMindtree'}, {sym:'PIDILITIND', name:'Pidilite'}, {sym:'SIEMENS', name:'Siemens'},
        {sym:'IOC', name:'Indian Oil'}, {sym:'BEL', name:'Bharat Electronics'}, {sym:'TRENT', name:'Trent'}, {sym:'DLF', name:'DLF'},
        {sym:'VBL', name:'Varun Beverages'}, {sym:'GAIL', name:'GAIL India'}, {sym:'HAL', name:'Hindustan Aeronautics'}, {sym:'BANKBARODA', name:'Bank of Baroda'},
        {sym:'CHOLAFIN', name:'Cholamandalam'}, {sym:'VEDL', name:'Vedanta'}, {sym:'AMBUJACEM', name:'Ambuja Cements'}, {sym:'INDIGO', name:'InterGlobe Aviation'},
        {sym:'PNB', name:'Punjab National Bank'}, {sym:'CANBK', name:'Canara Bank'}, {sym:'HAVELLS', name:'Havells India'}, {sym:'SRF', name:'SRF Ltd'},
        {sym:'TVSMOTOR', name:'TVS Motor'}, {sym:'ABB', name:'ABB India'}, {sym:'SHREECEM', name:'Shree Cement'}, {sym:'DABUR', name:'Dabur'},
        {sym:'ZOMATO', name:'Zomato'}, {sym:'JIOFIN', name:'Jio Financial'}, {sym:'NIFTY', name:'Nifty 50 Index'}, {sym:'BTC-USD', name:'Bitcoin (USD)'}
    ];

    const input = document.getElementById('tickerInput');
    const list = document.getElementById('stockList');

    input.addEventListener('input', function() {
        const val = this.value.toUpperCase(); list.innerHTML = '';
        if (!val) { list.classList.remove('active'); return; }
        renderList(stocks.filter(s => s.sym.includes(val) || s.name.toUpperCase().includes(val)));
    });

    // Show List on Click
    input.addEventListener('click', function() {
        if (list.innerHTML === '') renderList(stocks);
        list.classList.add('active');
    });

    function renderList(items) {
        list.innerHTML = '';
        if (items.length > 0) {
            items.forEach(s => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="stock-ticker">${s.sym}</span> <span class="stock-name">${s.name}</span>`;
                li.onclick = () => {
                    input.value = s.sym;
                    list.classList.remove('active');
                    runAnalysis(); // Auto-Run
                };
                list.appendChild(li);
            });
            list.classList.add('active');
        } else {
            list.classList.remove('active');
        }
    }

    document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) list.classList.remove('active'); });

    // Quick Search
    function quickSearch(symbol) {
        input.value = symbol;
        runAnalysis();
    }

    // Analyze
    let chart;
    async function runAnalysis() {
        const ticker = input.value.toUpperCase();
        if(!ticker) return alert("Please select or enter a ticker.");
        
        // Hide Initial State
        const initState = document.getElementById('initial-state');
        if(initState) initState.style.display = 'none';

        document.getElementById('loader').style.display='block'; 
        document.getElementById('results').style.display='none';

        try {
            const res = await fetch('/api/analyze', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ticker:ticker})});
            const data = await res.json();
            if(data.error) throw new Error(data.error);
            
            // SAFE TEXT UPDATES
            const setText = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; };
            
            setText('d-ticker', data.ticker);
            setText('d-name', data.name || "");
            setText('d-current', "â‚¹" + (data.current_price || 0).toFixed(2));
            setText('d-open', "â‚¹" + (data.prediction?.open || 0).toFixed(2));
            setText('d-close', "â‚¹" + (data.prediction?.close || 0).toFixed(2));
            
            const f = data.fundamentals || {};
            setText('f-cap', f.market_cap || "-");
            setText('f-pe', f.pe_ratio || "-");
            setText('f-roe', f.roe || "-");
            setText('f-div', f.div_yield || "-");
            setText('f-52h', f.high_52 ? "â‚¹" + f.high_52 : "-");
            setText('f-52l', f.low_52 ? "â‚¹" + f.low_52 : "-");
            setText('f-pb', f.pb_ratio || "-");
            setText('f-book', f.book_val || "-");

            setText('d-signal', data.signal);
            setText('d-sentiment', data.sentiment?.label || "-");
            setText('d-lstm', "â‚¹" + (data.prediction?.lstm || 0).toFixed(2));
            setText('d-xgb', "â‚¹" + (data.prediction?.xgboost || 0).toFixed(2));
            setText('d-rf', "â‚¹" + (data.prediction?.rf || 0).toFixed(2));
            setText('d-dt', "â‚¹" + (data.prediction?.dt || 0).toFixed(2));
            
            const lstmEl = document.getElementById('lstm-trend');
            if(lstmEl) {
                const diff = (data.prediction?.lstm || 0) - data.current_price;
                lstmEl.innerText = diff > 0 ? "Bullish" : "Bearish";
                lstmEl.style.color = diff > 0 ? 'var(--bullish)' : 'var(--bearish)';
            }

            // News Impact
            const news = data.news_impact || {};
            setText('news-summary', news.summary || "No news found.");
            setText('news-headline', news.headline ? `Latest: "${news.headline.substring(0,60)}..."` : "Latest: N/A");
            const nScore = document.getElementById('news-score');
            if(nScore) {
                nScore.innerText = news.score > 0 ? "BULLISH" : (news.score < 0 ? "BEARISH" : "NEUTRAL");
                nScore.style.color = news.score > 0 ? "var(--bullish)" : (news.score < 0 ? "var(--bearish)" : "var(--muted)");
            }

            // Accuracy
            const acc = data.accuracy || {avg:0, week:0, history:[]};
            setText('d-acc-week', acc.week + "%");
            const accBar = document.getElementById('acc-bar');
            if(accBar) accBar.style.width = acc.avg + "%";
            
            const tbody = document.getElementById('acc-table-body');
            if(tbody) {
                tbody.innerHTML = "";
                acc.history.forEach(h => {
                    tbody.innerHTML += `<tr><td>${h.day}</td><td>â‚¹${h.predicted}</td><td>â‚¹${h.actual}</td><td style="color:var(--accent)">${h.acc_score}%</td></tr>`;
                });
            }

            renderChart(data.history || [], data.prediction?.open, data.prediction?.close);
            document.getElementById('loader').style.display='none'; document.getElementById('results').style.display='grid';
        } catch(e) { 
            console.error(e); alert("Analysis Failed: " + e.message); 
            document.getElementById('loader').style.display='none'; 
        }
    }

    function renderChart(history, open, close) {
        if(chart) chart.destroy();
        let lastDate = new Date().getTime();
        if(history.length > 0) lastDate = new Date(history[history.length-1].x).getTime();
        let tomorrow = lastDate + 86400000;
        var options = {
            series: [{ name: 'Price', data: history }],
            chart: { type: 'candlestick', height: 350, background: 'transparent', toolbar: { show: false } },
            theme: { mode: 'dark' },
            plotOptions: { candlestick: { colors: { upward: '#00E396', downward: '#FF4560' }, wick: { useFillColor: true } } },
            grid: { borderColor: 'rgba(255,255,255,0.05)' },
            xaxis: { type: 'datetime', tooltip: { enabled: false }, axisBorder: { show: false } },
            yaxis: { labels: { style: { colors: '#94a3b8' }, formatter: (val) => val ? val.toFixed(0) : 0 } },
            annotations: { points: [
                { x: tomorrow, y: open, marker: { size: 5, fillColor: '#38bdf8', strokeColor: '#fff', strokeWidth: 2 }, label: { borderColor: '#38bdf8', style: { color: '#000', background: '#38bdf8' }, text: 'Open' } },
                { x: tomorrow, y: close, marker: { size: 6, fillColor: '#00E396', strokeColor: '#fff', strokeWidth: 2 }, label: { borderColor: '#00E396', style: { color: '#fff', background: '#00E396' }, text: 'Close' } }
            ]}
        };
        chart = new ApexCharts(document.querySelector("#mainChart"), options);
        chart.render();
    }
  </script>
</body>
</html>